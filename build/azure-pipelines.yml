parameters:
- name: canPublish
  displayName: Deploy to nuget
  type: boolean
  default: false

trigger:
    branches:
        include:
         - 'master'

stages:
- stage: BUILD_AND_TEST
  pool: databinding self hosted interactive

  jobs:
  - job:
    steps:
    - task: GitVersion@5
      inputs:
        mode: Mainline
      displayName: Run GitVersion task
  
    - script: echo %Action%%BuildVersion%
      displayName: Set build version
      env:
        Action: '##vso[build.updatebuildnumber]'
        BuildVersion: $(GitVersion.SemVer)

    - powershell: |
       New-Item mkdocs.yml -Force
             Add-Content -path mkdocs.yml "
             site_name: T4.FileManager.VisualStudio Documentation $(GitVersion.SemVer)
             site_description: 'Manager for generating multiple files with T4 text templates.'
             site_author: 'databinding gmbh'
             docs_dir: docs/
             repo_name: ' $(Build.Repository.Name)'
             repo_url: '$(Build.Repository.Uri)'
             theme:
               name: 'material'
             markdown_extensions:
                - pymdownx.highlight:
                    linenums_style: pymdownx.inline
                - pymdownx.superfences  
               "
      displayName: 'Create mkdocs.yml'

    - script: |
         pip install mkdocs
         mkdocs build 
      displayName: 'Build Documentation'

    - task: CopyFiles@2
      displayName: 'Copy documentation'
      inputs:
        SourceFolder: site
        TargetFolder: '$(Build.ArtifactStagingDirectory)\documentation'

    - task: NuGetToolInstaller@1
      displayName: 'Use NuGet '
      inputs:
        checkLatest: true


    
      
- ${{ if eq(parameters.canPublish, true) }}: 
  - stage: DEPLOY_TO_NUGET
    pool: databinding self hosted interactive
    variables:
      - group: Prod

    jobs:
    - job:
      steps:

      - task: PowerShell@2
        inputs:
          targetType: 'filePath'
          filePath: 'drop/drop/NuGetMessage.ps1'
          arguments: > # Use this to avoid newline characters in multiline string
            -uri "$(SmToken)"
            -version $(Build.BuildNumber)
            -nugeturl $(NuGetUrl)